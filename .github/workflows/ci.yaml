name: Continuous Integration (Main)

on:
    pull_request:
        branches: ["main"]
    push:
        branches: ["main"]

permissions:
    contents: write
    pull-requests: write
    actions: write

jobs:
    test-and-build:
        name: Test and Build Verification
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20 # Updated to 20 for better stability

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Install system dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Check build (Frontend)
              run: pnpm run build

            - name: Check build (Tauri backend)
              # Solo verificamos que compile en Linux para el CI rÃ¡pido
              uses: dtolnay/rust-toolchain@stable

            - name: Rust cache
              uses: swatinem/rust-cache@v2

            - name: Verify Tauri build
              run: pnpm tauri build --no-bundle # Build rÃ¡pido sin empaquetar

    promote-to-release:
        name: Auto Merge main -> release
        needs: test-and-build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create and Merge PR
              run: |
                  HEAD_BRANCH="main"
                  BASE_BRANCH="release"

                  # Check if PR already exists
                  PR_URL=$(gh pr list --head "$HEAD_BRANCH" --base "$BASE_BRANCH" --json url --jq '.[0].url')

                  if [ -z "$PR_URL" ]; then
                    echo "Creating new PR from $HEAD_BRANCH to $BASE_BRANCH..."
                    PR_URL=$(gh pr create \
                      --base "$BASE_BRANCH" \
                      --head "$HEAD_BRANCH" \
                      --title "ðŸš€ Production: Merge $HEAD_BRANCH into $BASE_BRANCH" \
                      --body "Automated PR created by CI. Build and tests passed on $HEAD_BRANCH." \
                      --fill) || echo "Failed to create PR (might be permissions or no changes)"
                  else
                    echo "PR already exists: $PR_URL"
                  fi

                  # Attempt to merge if we have a PR URL
                  if [ -n "$PR_URL" ]; then
                    echo "Merging PR..."
                    gh pr merge "$HEAD_BRANCH" --merge --admin || echo "Failed to merge PR"
                  else
                    echo "No PR found to merge. Trying direct merge as fallback..."
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"
                    git fetch origin "$BASE_BRANCH"
                    git checkout "$BASE_BRANCH"
                    git merge "$HEAD_BRANCH"
                    git push origin "$BASE_BRANCH" || echo "Direct push failed (branch protection?)"
                  fi

                  # Trigger build
                  gh workflow run build.yaml --ref "$BASE_BRANCH" || echo "Failed to trigger build workflow"
