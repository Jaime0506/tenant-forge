name: Continuous Integration (Main)

on:
    pull_request:
        branches: ["main"]
    push:
        branches: ["main"]

permissions:
    contents: write
    pull-requests: write

jobs:
    test-and-build:
        name: Test and Build Verification
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20 # Updated to 20 for better stability

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Check build (Frontend)
              run: pnpm run build

            - name: Check build (Tauri backend)
              # Solo verificamos que compile en Linux para el CI rÃ¡pido
              uses: dtolnay/rust-toolchain@stable

            - name: Rust cache
              uses: swatinem/rust-cache@v2

            - name: Verify Tauri build
              run: pnpm tauri build --no-bundle # Build rÃ¡pido sin empaquetar

    create-release-pr:
        name: Auto PR Main -> Release
        needs: test-and-build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create Pull Request to Release
              run: |
                  # Verificar si existe la rama release
                  if ! git show-ref --verify --quiet refs/remotes/origin/release; then
                    echo "Error: Branch 'release' does not exist."
                    exit 1
                  fi

                  # Intentar crear el PR
                  gh pr create \
                    --base release \
                    --head main \
                    --title "ðŸš€ Production: Merge main into release" \
                    --body "Automated PR created by CI after successful build and tests on main branch." \
                    || echo "PR already exists or nothing to merge."
