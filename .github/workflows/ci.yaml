name: Continuous Integration (Main)

on:
    pull_request:
        branches: ["main"]
    push:
        branches: ["main"]

permissions:
    contents: write
    pull-requests: write

jobs:
    test-and-build:
        name: Test and Build Verification
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20 # Updated to 20 for better stability

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Install system dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Check build (Frontend)
              run: pnpm run build

            - name: Check build (Tauri backend)
              # Solo verificamos que compile en Linux para el CI r치pido
              uses: dtolnay/rust-toolchain@stable

            - name: Rust cache
              uses: swatinem/rust-cache@v2

            - name: Verify Tauri build
              run: pnpm tauri build --no-bundle # Build r치pido sin empaquetar

    promote-to-release:
        name: Auto Merge main -> release
        needs: test-and-build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create and Merge PR
              run: |
                  # 1. Crear el PR
                  gh pr create \
                    --base release \
                    --head main \
                    --title "游 Production: Merge main into release" \
                    --body "Automated PR created by CI. Build and tests passed on main." \
                    || echo "PR already exists."

                  # 2. Hacer el merge (esto pondr치 el c칩digo en release)
                  gh pr merge --merge --admin

                  # 3. Disparar el build de producci칩n expl칤citamente
                  gh workflow run build.yaml --ref release
